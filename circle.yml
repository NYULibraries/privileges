machine:
  environment:
    SOLR_URL: 'http://localhost:8984/solr/test'
    LOGIN_URL: 'https://dev.login.library.nyu.edu'
    SSO_LOGOUT_PATH: /logout

dependencies:
  pre:
    - gem update bundler
    - bundle config github.https true
    - sudo DEBIAN_FRONTEND=noninteractive apt-get install -y libmemcached10
    - yes | pecl install -f memcached-2.1.0
  post:
    - mysql -e 'create database privileges_test;'
    - RAILS_ENV=test bundle exec rake db:schema:load
    - bundle exec sunspot-solr start -p 8984
    - sleep 10
test:
  override:
    - RAILS_ENV=test bundle exec rspec --color --format progress
    - mkdir -p $CIRCLE_TEST_REPORTS/cucumber
    - RAILS_ENV=test bundle exec cucumber --format pretty --format json --out $CIRCLE_TEST_REPORTS/cucumber/tests.cucumber
    - RAILS_ENV=test bundle exec rake test
  post:
    - bundle exec rake coveralls:push

deployment:
  production:
    branch: master
    commands:
      - curl -u $JENKINS_USERNAME:$JENKINS_API_KEY -X POST http://jenkins.library.nyu.edu/view/Privileges%20Guide/job/Privileges%20Guide%20Production%20Deploy/build/api
  development:
    branch: /.+/
    commands:
      - curl -u $JENKINS_USERNAME:$JENKINS_API_KEY -X POST http://jenkins.library.nyu.edu/view/Privileges%20Guide/job/Privileges%20Guide%20Development%20Deploy/build/api
